---
title: Rustã§OpenTelemetryã‚’è¨ˆè£…
date: 2025-07-12
summary: ä»Šå¹´ã®ç›®æ¨™ã§æ²ã’ãŸé€šã‚Šã€Rustã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«å¯¾ã—ã¦OpenTelemetryã‚’è¨ˆè£…ã™ã‚‹å­¦ç¿’ã‚’ã—ã¾ã—ãŸã€‚ãã®å­¦ç¿’å†…å®¹ã‚’ã¾ã¨ã‚ãŸè¨˜äº‹ã§ã™ã€‚
tags:
  - label: Rust
  - label: Observability
---

## ã¯ã˜ã‚ã«

ä»Šå¹´ã®ã¯ã˜ã‚ã«æ²ã’ãŸç›®æ¨™ã®ã¨ãŠã‚Šã€Rustã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¸OpenTelemetryã‚’å°å…¥ã—ã€ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’å‡ºåŠ›ã™ã‚‹ãŸã‚ã®å­¦ç¿’ã‚’è¡Œã„ã¾ã—ãŸã€‚æœ¬è¨˜äº‹ã¯ãã®å‚™å¿˜éŒ²ã§ã™ã€‚

å¯¾è±¡èª­è€…ã¯ã€ŒRustã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«OpenTelemetryã‚’å°å…¥ã—ãŸã„æ–¹ã€ã‚’æƒ³å®šã—ã¦ã„ã¾ã™ã€‚Rustã‚„OpenTelemetryã€ã•ã‚‰ã«ãã®åŸºç›¤ã«ã‚ã‚‹ã‚ªãƒ–ã‚¶ãƒ¼ãƒãƒ“ãƒªãƒ†ã‚£é–¢é€£ã®ç”¨èªã«ã¤ã„ã¦ã¯æœ€ä½é™ã®èª¬æ˜ã«ç•™ã‚ã¦ã„ã¾ã™ã®ã§ã€ã”äº†æ‰¿ãã ã•ã„ã€‚

## OpenTelemetry

### æ¦‚è¦

OpenTelemetryã¯ã€ã‚ªãƒ–ã‚¶ãƒ¼ãƒãƒ“ãƒªãƒ†ã‚£ã«é–¢ã™ã‚‹ãƒ†ãƒ¬ãƒ¡ãƒˆãƒªãƒ¼ãƒ‡ãƒ¼ã‚¿ã®æ¨™æº–è¦æ ¼ãŠã‚ˆã³å–å¾—ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’æä¾›ã™ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã™ã€‚å…±é€šä»•æ§˜ãŒã‚ã‚‹ã“ã¨ã§ãƒ™ãƒ³ãƒ€ãƒ¼ãƒ­ãƒƒã‚¯ã‚¤ãƒ³ã‚’å›é¿ã§ãã‚‹ã ã‘ã§ãªãã€è¤‡æ•°ãƒ„ãƒ¼ãƒ«é–“ã§ãƒ†ãƒ¬ãƒ¡ãƒˆãƒªãƒ¼ã‚’ç›¸é–¢ä»˜ã‘ãŸåˆ†æãŒå®¹æ˜“ã«ãªã‚Šã¾ã™ã€‚å¾“æ¥ã‹ã‚‰åŒæ§˜ã®æµã‚Œã¯ã‚ã‚Šã¾ã—ãŸãŒã€OpenTelemetryã®ç™»å ´ã«ã‚ˆã‚Šäº‹å®Ÿä¸Šã®æ¨™æº–ã¨ãªã‚Šã¾ã—ãŸã€‚

è©³ç´°ã¯æœ¬é¡Œã‹ã‚‰å¤–ã‚Œã‚‹ãŸã‚ã€æœ€å¾Œã®ã€Œå‚è€ƒè¨˜äº‹ã€ã«é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’åˆ—æŒ™ã—ã¦ã„ã¾ã™ã€‚èˆˆå‘³ãŒã‚ã‚Œã°ã”å‚ç…§ãã ã•ã„ã€‚

### Rustã§ã®é–‹ç™ºçŠ¶æ³

åŸ·ç­†æ™‚ç‚¹ã§ã¯ã€[OpenTelemetryã®é–‹ç™ºçŠ¶æ³](https://opentelemetry.io/ja/docs/languages/rust/)ã¯ã™ã¹ã¦`Beta`ã§ã€ãƒˆãƒ¬ãƒ¼ã‚¹ã®ãŸã‚ã®æ­£å¼ãªå®‰å®šç‰ˆã¯ãƒªãƒªãƒ¼ã‚¹ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
ãã®ä¸»ãªè¦å› ã®ä¸€ã¤ã¨ã—ã¦ã€ãƒˆãƒ¬ãƒ¼ã‚¹ã®å–å¾—æ–¹æ³•ãŒOpenTelemetryã®APIã‚’ä½¿ç”¨ã™ã‚‹ã‹ã€tokioãŒæä¾›ã—ã¦ã„ã‚‹`tracing`ã‚¯ãƒ¬ãƒ¼ãƒˆã‚’ä½¿ç”¨ã™ã‚‹ã‹ãŒå®šã¾ã£ã¦ã„ãªã„ã“ã¨ãŒæŒ™ã’ã‚‰ã‚Œã¾ã™ã€‚ã“ã®ç‚¹ã«ã¤ã„ã¦ã¯[GitHub Issue](https://github.com/open-telemetry/opentelemetry-rust/issues/1571)ã§ç¶™ç¶šçš„ã«è­°è«–ã•ã‚Œã¦ãŠã‚Šã€ç¾æ™‚ç‚¹ã§ã¯æ–¹é‡ãŒç¢ºå®šã—ã¦ã„ãªã„ã‚ˆã†ã§ã™ã€‚

æœ¬è¨˜äº‹ã§ã¯ã€**`tracing`ã‚¯ãƒ¬ãƒ¼ãƒˆãŠã‚ˆã³opentelemetryã¨é€£æºã•ã›ã‚‹`tracing-opentelemetry`ã‚’åˆ©ç”¨ã™ã‚‹**ã“ã¨ã‚’å‰æã«è¨˜è¼‰ã—ã¾ã™ã€‚æ¡ç”¨ã—ãŸç†ç”±ã¨ã—ã¦ã¯ã€

- ã™ã§ã«`tracing`ã‚¯ãƒ¬ãƒ¼ãƒˆã‚’åˆ©ç”¨ã—ã¦ã„ãŸã‚‚ã®ãŒã‚ã£ãŸ
- ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚„ãƒˆãƒ¬ãƒ¼ã‚¹ã¨ãƒ­ã‚°ã®ç´ä»˜ã‘ãªã©ä½•ã‹ã¨ä¾¿åˆ©ã ã¨æ€ã£ãŸ
- tokioã‹ã‚‰æä¾›ã•ã‚Œã¦ã„ã‚‹

ã‹ã‚‰ã§ã™ã€‚å‚è€ƒã«ã—ãŸã€[Rustã§OpenTelemetry](https://www.docswell.com/s/ymgyt/5Q8VL7-opentelemetry-with-rust#p1)ã¨ä¼¼ãŸã‚ˆã†ãªç†ç”±ã«ãªã‚Šã¾ã—ãŸã€‚

å®Ÿè£…æ™‚ã«æ°—ã‚’ã¤ã‘ãŸã„ç‚¹ã¨ã—ã¦ã€`opentelemetry-rust`ã‚¯ãƒ¬ãƒ¼ãƒˆã¨`tracing`ã‚¯ãƒ¬ãƒ¼ãƒˆã®ä¸¡æ–¹ã‚’å‚ç…§ã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚`tracing-opentelemetry`ã¨`opentelemetry-rust`ã§ã¯åŒã˜åå‰ã®é–¢æ•°ãŒå­˜åœ¨ã™ã‚‹å ´åˆãŒã‚ã‚Šã€ã©ã¡ã‚‰ã‚’ä½¿ç”¨ã™ã‚‹ã‹ã‚’æ˜ç¢ºã«æ„è­˜ã—ã¦ã„ãªã„ã¨ã€ãƒˆãƒ¬ãƒ¼ã‚¹ãŒæ­£å¸¸ã«å‡ºåŠ›ã•ã‚Œãªã„ã¨ã„ã†å•é¡Œã«é­é‡ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã“ã®ç‚¹ã«ã”æ³¨æ„ãã ã•ã„ã€‚


## ãƒˆãƒ¬ãƒ¼ã‚¹ã®å–å¾—

### ç”¨èªã®æ•´ç†ï¼ˆãƒˆãƒ¬ãƒ¼ã‚¹ï¼‰

ã„ã–å®Ÿè£…ã—ã‚ˆã†ã¨ã„ã†å‰ã«ã€ã“ã‚Œã‹ã‚‰å‡ºã¦ãã‚‹ç”¨èªã®æ•´ç†ã‚’ã—ã¾ã™ã€‚ä»Šã“ã“ã§èª­ã‚“ã§ã‚‚ã‚ã‹ã‚‰ãªã„ã¨æ€ã†ã®ã§ã€å®Ÿè£…ã—ãªãŒã‚‰ç†è§£ã‚’æ·±ã‚ãŸã‚‰è‰¯ã„ã¨æ€ã„ã¾ã™ã€‚

- `Tracer`
  - Spanç”Ÿæˆã‚’æ‹…ã†
  - é€†ã«Spanã¯`Tracer`ã—ã‹ç”Ÿæˆã§ããªã„
- `TracerProvider`
  - `Tracer`ã®ç”Ÿæˆã‚’æ‹…ã„ã€`Tracer`ã®å…±é€šè¨­å®šã‚’è¡Œã†
  - è¨­å®šã§ãã‚‹ã‚‚ã®
    - `SpanProcessor`ï¼ˆå¾Œè¿°ï¼‰
    - [ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°è¨­å®š](https://opentelemetry.io/ja/docs/concepts/sampling/)
    - [`Resource`](https://opentelemetry.io/ja/docs/concepts/resources/)æƒ…å ±(ã‚µãƒ¼ãƒ“ã‚¹åãªã©)
- `SpanProcessor`
  - ã‚¹ãƒ‘ãƒ³ã®å‡ºåŠ›ã™ã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’åˆ¶å¾¡ã‚’æ‹…ã†
  - `BatchSpanProcessor`ã§ã¾ã¨ã‚ã¦é€ã‚‹ã“ã¨ãŒå¤šã„ã‚ˆã†ã«è¦‹ãˆã‚‹
  - å‡ºåŠ›æ‰‹æ®µã¨ã—ã¦`Exporter`ã‚’æŒ‡å®šã™ã‚‹
- `SpanExporter`
  - ãƒ†ãƒ¬ãƒ¡ãƒˆãƒªãƒ‡ãƒ¼ã‚¿ã‚’æ¨™æº–å‡ºåŠ›ã‚‚ã—ãã¯å¤–éƒ¨ã¸å‡ºåŠ›ã™ã‚‹ã®ãŒ`Exporter`ã§ã‚ã‚Šã€ã¨ã‚Šã‚ã‘ã‚¹ãƒ‘ãƒ³ã‚’å‡ºåŠ›ã‚’æ‹…ã†ã®ãŒ`SpanExporter`ã§ã‚ã‚‹
  - OpenTelemetryãŒå®šã‚ãŸãƒ—ãƒ­ãƒˆã‚³ãƒ«ï¼ˆ[OTLP](https://opentelemetry.io/docs/specs/otlp/)ï¼‰ç”¨ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ã‚¿ãƒ¼ã‚„å„ãƒ™ãƒ³ãƒ€ãƒ¼ã¸å‡ºåŠ›ã™ã‚‹ãŸã‚ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ã‚¿ãƒ¼ãªã©ã‚’æŒ‡å®šã™ã‚‹

ã“ã¡ã‚‰ã®ç”¨èªã¯[OpenTelemetry Specifications](https://opentelemetry.io/docs/specs/)ã§å®šã‚ã‚‰ã‚Œã¦ã„ã¦ã©ã®è¨€èªã§ã‚‚å¤‰ã‚ã‚‰ãªã„ãŸã‚ã€ç†è§£ã—ã¦ãŠãã¨ä»–ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«å¯¾ã—ã¦ã‚‚OpenTelemetryã®è¨ˆè£…ã®ãƒãƒ¼ãƒ‰ãƒ«ãŒä¸‹ãŒã‚Šã¾ã™ã€‚

### ãƒˆãƒ¬ãƒ¼ã‚¹å–å¾—ã™ã‚‹ã¾ã§ã®æµã‚Œ

Rustã®crateã®é–¢ä¿‚ã‚„æµã‚Œã¯ã€ã‚ã‹ã‚Šã‚„ã™ãèª¬æ˜ã—ã¦ãã ã•ã£ã¦ã„ã¾ã™ã€‚
![crateã®é–¢ä¿‚](https://blog.ymgyt.io/entry/understanding-opentelemetry-tracer-configuration-from-specifications/images/opentelemetry_crates_overview.svg)
_[å¼•ç”¨:Rustã§OpenTelemetry: Tracerã®è¨­å®šã‚’ä»•æ§˜ã‹ã‚‰ç†è§£ã™ã‚‹](https://blog.ymgyt.io/entry/understanding-opentelemetry-tracer-configuration-from-specifications/)_

![Traceã®ç”Ÿæˆã‹ã‚‰exportã¾ã§ã®æµã‚Œ](https://blog.ymgyt.io/entry/understanding-opentelemetry-tracer-configuration-from-specifications/images/opentelemetry_trace_flow_overview.svg)
_[å¼•ç”¨:Rustã§OpenTelemetry: Tracerã®è¨­å®šã‚’ä»•æ§˜ã‹ã‚‰ç†è§£ã™ã‚‹](https://blog.ymgyt.io/entry/understanding-opentelemetry-tracer-configuration-from-specifications/)_

ã“ã‚Œã‚‚ã‚ã‹ã‚Šã‚„ã™ã„ã§ã™ãŒã€è‡ªåˆ†ã®ç†è§£ã®ãŸã‚ã«è‡ªåˆ†ã®è¨€è‘‰ã¨ã—ã¦èª¬æ˜ã—ã¾ã™ã€‚

ã¾ãšã¯ã€OpentelemetryãŒç”¨æ„ã—ã¦ã„ã‚‹ã‚¯ãƒ¬ãƒ¼ãƒˆã‚’ç”¨ã„ã¦ã€åŸºæœ¬çš„ãªOpenTelemetryã®è¨­å®šã‚’ã—ã¾ã™ã€‚

1. `SpanExporter`ã‚’è¨­å®šã™ã‚‹ï¼ˆ`opentelemetry-otlp`ï¼‰
   1. OpenTelemetry Collectorã¸ã¯OTLPã§é€šä¿¡ã™ã‚‹ãŸã‚OTLPã‚¨ã‚¯ã‚¹ãƒãƒ¼ã‚¿ãƒ¼ã‚’ä½¿ã†
2. `TracerProvider`ã‚’è¨­å®šã™ã‚‹ï¼ˆ`opentelemetry`ï¼‰
   1. ã‚¨ã‚¯ã‚¹ãƒãƒ¼ã‚¿ãƒ¼ã«ã¯1ã§è¨­å®šã—ãŸã®ã‚’æŒ‡å®šã™ã‚‹
   2. `SpanProcessor`ã¨ã—ã¦ã¯ãƒãƒƒãƒå‡ºåŠ›ã™ã‚‹ã‚‚ã®ã‚’æŒ‡å®šã™ã‚‹
   3. `Resource`ã¨ã—ã¦ã‚µãƒ¼ãƒ“ã‚¹åãªã©ã‚’æŒ‡å®šã™ã‚‹
3. `TracerProvider`ã‹ã‚‰`Tracer`ã‚’å‡ºåŠ›ã™ã‚‹ï¼ˆ`opentelemetry-sdk`ï¼‰

æ¬¡ã«ã€`tracing`ãŒç”¨æ„ã—ã¦ã„ã‚‹ã‚¯ãƒ¬ãƒ¼ãƒˆã‚’ç”¨ã„ã¦ã€å…ˆã»ã©ã®OpenTelemetryã®è¨­å®šã‚’åæ˜ ã•ã›ã¾ã™ã€‚

4. `TracingSubscriber`ã®`OpenTelemetryLayer`ã«`tracer`ã‚’è¨­å®šã™ã‚‹ï¼ˆ`tracing-opentelemetry`ï¼‰
   1. `tracing-opentelemetry`ãŒopentelemetryã‹ã‚‰tracingã¸å¤‰æ›ã—ã¦ãã‚Œã¦ã„ã‚‹
   2. `TracingSubscriber`ã¨ã¯`tracing`ã‚¯ãƒ¬ãƒ¼ãƒˆã®ãƒ­ã‚°å‡ºåŠ›ã‚’åˆ¶å¾¡ã™ã‚‹ã‚‚ã®ã§ã€ä¾‹ãˆã°ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã—ãŸã‚Šã€JSONã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã—ãŸã‚Šã§ãã‚‹
5. `TracingSubscriber`ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«è¨­å®šã™ã‚‹

æœ€å¾Œã«ã‚¹ãƒ‘ãƒ³ã‚’å‡ºåŠ›ã™ã‚‹ç®‡æ‰€ã‚’æŒ‡å®šã—ã¾ã™ã€‚

6. `tracing`ã®æ©Ÿèƒ½ã§ã‚ã‚‹ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç”¨ã„ã¦è¨­å®šã™ã‚‹

### è¨ˆè£…

ã¾ãšã¯1ã€œ3ã®OpenTelemetryã®éƒ¨åˆ†ã§ã™ã€‚

```rust
use opentelemetry::trace::TracerProvider;
use opentelemetry_otlp::WithExportConfig;
use opentelemetry_sdk::trace::{SdkTracerProvider, Tracer};

// tracerã‚’åˆæœŸåŒ–ã™ã‚‹é–¢æ•°
pub fn init_tracer(service_name: &str) -> (Tracer, SdkTracerProvider) {

    // OTLPã‚¨ã‚¯ã‚¹ãƒãƒ¼ã‚¿ãƒ¼ã‚’è¨­å®š
    let otlp_exporter = opentelemetry_otlp::SpanExporter::builder()
        .with_tonic()
        .with_endpoint("http://otel-collector:4318")
        .build()
        .expect("Failed to build the span exporter");

    // TracerProviderã®è¨­å®š
    let provider = SdkTracerProvider::builder()
        .with_resource(
            Resource::builder()
                .with_service_name(service_name.to_string()) // ã‚µãƒ¼ãƒ“ã‚¹åã‚’ä»˜ä¸
                .build(),
        )
        .with_batch_exporter(otlp_exporter) // BatchProcessorã‚’æŒ‡å®š
        .build();
    global::set_tracer_provider(provider.clone());

    // 3. Tracerã¨TracerProviderã‚’è¿”ã™
    (provider.tracer(service_name.to_owned()), provider)
}
```

ã“ã‚Œã‚’Tracingã«é€£æºã•ã›ã¾ã™ã€‚

```rust
use opentelemetry_sdk::trace::{SdkTracerProvider, Tracer};
use tracing_opentelemetry::OpenTelemetryLayer;
use tracing_subscriber::layer::SubscriberExt;
use tracing_subscriber::{fmt, EnvFilter, Registry};

pub fn init_telemetry(service_name: &str) -> opentelemetry_sdk::trace::SdkTracerProvider {

    // 4. OpenTelemetryLayerã«Tracerã‚’è¨­å®šã™ã‚‹
    let (tracer, provider) = init_tracer(service_name);
    let telemetry = OpenTelemetryLayer::new(tracer);

    // 5. Subscriberã‚’è¨­å®šã™ã‚‹
    let env_filter = EnvFilter::try_from_default_env().unwrap_or(EnvFilter::new("info"));
    let log_format = std::env::var("RUST_LOG_FORMAT").unwrap_or_else(|_| "pretty".to_string());
    let subscriber = Registry::default()
        .with(env_filter)
        .with(telemetry)
        .with(fmt::Layer::default());
    tracing::subscriber::set_global_default(subscriber)
        .expect("Failed to install `tracing` subscriber.");

    provider
}
```

ä½œæˆã—ãŸ`init_telemetry`ã‚’ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹æ™‚ã«å®Ÿè¡Œã™ã‚‹ã“ã¨ã§`tracing`ã‚¯ãƒ¬ãƒ¼ãƒˆã‚’ä½¿ã£ã¦ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’å‡ºåŠ›ã§ãã¾ã™ã€‚
ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’å‡ºåŠ›ã™ã‚‹ç®‡æ‰€ã¯`tracing::instrument`ã¨ã„ã†ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã§æŒ‡å®šã—ã¾ã™ã€‚ä»¥ä¸‹ã€ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚’ä¾‹ã«è¨ˆè£…ã—ã¦ã¿ã¾ã™ã€‚

```rust
// tracing::instrumentã¨è¨˜è¼‰ã•ã‚ŒãŸç®‡æ‰€ãŒã‚¹ãƒ‘ãƒ³ã¨ã—ã¦å‡ºåŠ›ã•ã‚Œã‚‹
#[tracing::instrument()]
#[get("/health")]
async fn health_check() -> impl Responder {
    HttpResponse::Ok().body("OK")
}

// instrumentã®å¼•æ•°ã«è¨­å®šã™ã‚‹ã‚¿ã‚°ãªã©ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ãŒã§ãã‚‹ï¼ˆã“ã“ã§ã¯http.uriã‚’è¿½åŠ ã—ã¦ã„ã‚‹ï¼‰
#[tracing::instrument(fields(http.uri = "/db-health", http.status_code = tracing::field::Empty))]
#[get("/db-health")]
async fn db_health_check(pool: web::Data<PgPool>) -> impl Responder {
    info!("SELECT 1");
    match sqlx::query("SELECT 1").fetch_one(&**pool).await {
        Ok(_) => {
            Span::current().record("http.status_code", 200);
            HttpResponse::Ok().body("DB OK")
        }
        Err(_) => {
            error!("Database connection failed");
            HttpResponse::InternalServerError().body("DB Error")
        }
    }
}
```

`tracing`ã‚¯ãƒ¬ãƒ¼ãƒˆã‚’ä½¿ã†ãƒ¡ãƒªãƒƒãƒˆã¯ã€ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã ã‘ã§ãªãã€å‡ºåŠ›ã™ã‚‹ãƒ­ã‚°ã‚’Spanã®ãƒ­ã‚°ã¨ã—ã¦ç´ã¥ã‘ã¦ãã‚Œã‚‹ã¨ã“ã‚ã‚‚ä¾¿åˆ©ã§ã™ã€‚

![Jaegerã§ã®ãƒˆãƒ¬ãƒ¼ã‚¹è¡¨ç¤º](/20250719_jaeger.png)

## ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆä¼æ¬

ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’å‡ºåŠ›ã™ã‚‹ã“ã¨ã¯ç„¡äº‹ã§ãã¾ã—ãŸã€‚ã—ã‹ã—ã€APIé€£æºã—ã¦ã„ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã§ãã‚Œãã‚Œãƒˆãƒ¬ãƒ¼ã‚¹ã‚’å‡ºåŠ›ã•ã›ã¦ã‚‚ã€1ã¤ã®ãƒˆãƒ¬ãƒ¼ã‚¹ã¨ã—ã¦ã¤ãªãŒã‚Šã¾ã›ã‚“ã€‚
ãªãœãªã‚‰ãƒˆãƒ¬ãƒ¼ã‚¹ã§é‡è¦ãªã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆä¼æ¬ã‚’ã—ã¦ã„ãªã„ã‹ã‚‰ã§ã™ã€‚æœ¬ç¯€ã§ã¯ãã®å®Ÿè£…ã®è§£èª¬ã‚’ã—ã¾ã™ã€‚

### ç”¨èªã®æ•´ç†ï¼ˆã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆä¼æ¬ï¼‰

- ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼ˆContextï¼‰
  - ã‚¹ãƒ‘ãƒ³ã‚’1ã¤ã®ãƒˆãƒ¬ãƒ¼ã‚¹ã¨ã—ã¦ç¹‹ã’ã‚‹ãŸã‚ã«å—ã‘æ¸¡ã—ã™ã‚‹æƒ…å ±ã®ã“ã¨
  - W3CãŒå®šã‚ã¦ã„ã‚‹[Trace Context](https://www.w3.org/TR/trace-context/)ã®è¦æ ¼ã«æ²¿ã£ã¦è¨­å®šã—ã¦ã„ã‚‹ã“ã¨ãŒå¤šã„
- ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆä¼æ¬ï¼ˆContextPropagationï¼‰
  - ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’åˆ¥ã®ã‚µãƒ¼ãƒ“ã‚¹ã¸ä¼æ¬ã•ã›ã‚‹ã“ã¨
  - HTTPã‚’ä½¿ã£ã¦ã„ã‚‹ãªã‚‰ãƒ˜ãƒƒãƒ€ãƒ¼ã¨ã—ã¦ã€ã‚­ãƒ¥ãƒ¼ã‚’ä½¿ã£ã¦ã„ã‚‹ãªã‚‰ã‚­ãƒ¥ãƒ¼ã®KeyValueå€¤ãªã©ã‚’ä½¿ã£ã¦ä¼æ¬ã•ã›ã‚‹
- Inject
  - ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆä¼æ¬ã§ãã‚‹ã‚ˆã†ã«ç”Ÿæˆã—ãŸã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±ã‚’ãƒ˜ãƒƒãƒ€ãƒ¼ãªã©ã«ä»˜ä¸ã™ã‚‹ã“ã¨
- Extract
  - ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆä¼æ¬ã§ãã‚‹ã‚ˆã†ã«ãƒ˜ãƒƒãƒ€ãƒ¼ãªã©ã‹ã‚‰ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±ã‚’æŠ½å‡ºã™ã‚‹ã“ã¨
  - ã“ã®è¡Œç‚ºã‚’ã™ã‚‹ã“ã¨ã«ã‚ˆã£ã¦åˆ¥ã‚µãƒ¼ãƒ“ã‚¹ã‹ã‚‰é€ã‚‰ã‚Œã¦ããŸãƒˆãƒ¬ãƒ¼ã‚¹IDã‚’ç´ã¥ã‘ã‚‹ã“ã¨ãŒã§ãã‚‹

### ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆä¼æ¬ã™ã‚‹æµã‚Œ

Injectã™ã‚‹å ´åˆã®æµã‚Œã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

1. `TextMapPropagator`ã‚’è¨­å®šã™ã‚‹
   1. TextMapPropagatorã¨ã¯ã‚­ãƒ¼ãƒãƒªãƒ¥ãƒ¼å€¤ã‚’ä¼æ¬ã•ã›ã‚‹ãŸã‚ã®ã‚‚ã®
   2. ãƒˆãƒ¬ãƒ¼ã‚¹ã®å ´åˆã¯`TraceContextPropagator`ã‚’è¨­å®šã™ã‚Œã°OK
2. Injectç”¨ã®é–¢æ•°ã‚’ç”¨æ„ã™ã‚‹
   1. åˆæœŸåŒ–ã—ãŸ`TextMapPropagator`ã‚’å–å¾—ã™ã‚‹
   2. PropagatorAPIã«å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹injectã‚’ä½¿ã†
3. ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‹å‰ã«ãƒ˜ãƒƒãƒ€ãƒ¼ã«Injectã™ã‚‹
   1. ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‹å‰ã«ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¨­å®šã—ã€2ã®é–¢æ•°ã‚’å‘¼ã³å‡ºã™

Extractã‚‚ã»ã¼åŒæ§˜ã§ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘å–ã£ãŸå¾Œã«å‘¼ã³å‡ºã™ã‚ˆã†ã«ã™ã‚Œã°OKã§ã™ã€‚

### Injectå®Ÿè£…ä¾‹

åˆæœŸåŒ–ç”¨ã®é–¢æ•°ã‚’ç”¨æ„ã—ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œæ™‚ã«å‘¼ã³å‡ºã™ã‚ˆã†ã«ã—ã¾ã™ã€‚

```rust
pub fn init_propagation() {
    let trace_propagator = TraceContextPropagator::new();

    global::set_text_map_propagator(trace_propagator);
}
```

Injectç”¨ã®é–¢æ•°ã‚’ç”¨æ„ã—ã¾ã™ã€‚
```rust
/// OpenTelemetryã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ãƒ˜ãƒƒãƒ€ãƒ¼ã«æ³¨å…¥ã™ã‚‹
///
/// # å¼•æ•°
/// * `context` - æ³¨å…¥ã™ã‚‹OpenTelemetryã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
/// * `headers` - æ³¨å…¥å…ˆã®ãƒ˜ãƒƒãƒ€ãƒ¼ãƒãƒƒãƒ—
pub fn inject_context(context: &Context, headers: &mut reqwest::header::HeaderMap) {
    opentelemetry::global::get_text_map_propagator(|propagator| {
        propagator.inject_context(context, &mut HeaderInjector(headers));
    });
}
```

ç”¨æ„ã—ãŸé–¢æ•°ã‚’ç”¨ã„ã¦ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡å‰ã«ç¾çŠ¶ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±ã‚’ãƒ˜ãƒƒãƒ€ãƒ¼ã«æ³¨å…¥ã—ã¾ã™ã€‚

```rust
use reqwest::{
    header::{HeaderMap, HeaderValue, AUTHORIZATION},
    Client,
};
use tracing::{info, Span};
use tracing_opentelemetry::OpenTelemetrySpanExt;

pub async fn create_user_and_profile(
  // ç•¥
) -> Result<UserResponse, Box<dyn std::error::Error>> {

    //ç•¥

    // headerã«Contextã‚’æ³¨å…¥
    let mut headers = HeaderMap::new();
    inject_context(&Span::current().context(), &mut headers);

    // ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡æ™‚ã«headerã‚’æŒ‡å®šã™ã‚‹
    let client = Client::new();
    let profile_response = client
        .post(format!("{}/api/profiles/register/", profile_api_url))
        .headers(headers)
        .json(&json!({
            "username": username,
            "email": email,
            "auth_user_id": user_id
        }))
        .send()
        .await?;

    // ç•¥
}
```

ã“ã¡ã‚‰ã§ä¼æ¬ã•ã‚Œã¾ã™ã€‚

### å°‚ç”¨ã‚¯ãƒ¬ãƒ¼ãƒˆã‚’ä½¿ç”¨ã—ã¦æ¥½ã—ã¾ã—ã‚‡ã†

ä¸Šè¨˜ã§ä¸€ã¤ä¸€ã¤Inject/Extractã‚’ã™ã‚Œã°ä¼æ¬ã§ãã¾ã™ãŒå¤§å¤‰ã§ã™ã€‚ãŸã ã€ã‚ˆãä½¿ã‚ã‚Œã‚‹ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã«ã¯è‡ªå‹•ã§è¨ˆè£…ã—ã¦ãã‚Œã‚‹ã‚¯ãƒ¬ãƒ¼ãƒˆã‚’èª°ã‹ãŒé–‹ç™ºã—ã¦ãã‚Œã‚‹ãŸã‚ã€ãã‚Œã‚’ä½¿ã‚ãªã„æ‰‹ã¯ãªã„ã§ã™ã€‚

ä»Šå›ã®ã‚µãƒ³ãƒ—ãƒ«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«å½“ã¦ã¯ã‚ã‚‹ã¨ã€ä»¥ä¸‹ãŒä½¿ãˆãã†ã§ã™ã€‚

- [tracing-actix-web](https://crates.io/crates/tracing-actix-web)
  - actix-webã§ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’è¨­å®šã™ã‚‹ç®‡æ‰€ã«`.wrap(tracing_actix_web::TracingLogger::default())`ã‚’åŸ‹ã‚è¾¼ã‚€
  - actix-webã§å—ä¿¡ã—ã¦ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã™ã‚‹ç®‡æ‰€ã«ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡ºã—ã¦ãã‚Œã‚‹
  - æ›¸ãæ–¹ã¯[å…¬å¼Githubã®Example](https://github.com/LukeMathWalker/tracing-actix-web/blob/main/examples/opentelemetry/src/main.rs)ã‚’å‚è€ƒã«ã™ã‚‹ã¨è‰¯ã„ã¨æ€ã„ã¾ã™
- [reqwest-tracing](https://crates.io/crates/reqwest-tracing)
  - ã“ã¡ã‚‰ã‚‚å…¬å¼ã«æ›¸ã„ã¦ã‚ã‚‹é€šã‚Šã€`client`ã‚’ç”Ÿæˆã™ã‚‹éš›ã«`reqwest-tracing`ãŒæä¾›ã™ã‚‹`TracingMiddleware`ã‚’å…¥ã‚Œã¦ãƒ“ãƒ«ãƒ‰ã—ã€ãã®`client`ã‚’ä½¿ã£ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚Œã°è‡ªå‹•ã§æ³¨å…¥ã™ã‚‹
  - ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèªã™ã‚‹é™ã‚Šã€é©åˆ‡ã«ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®æ³¨å…¥ãŒè¡Œã‚ã‚Œã¦ã„ã¾ã™ã€‚


## ã¾ã¨ã‚

é•·ããªã‚Šã¾ã—ãŸãŒã€ä»¥ä¸ŠãŒä»Šå›OpenTelemetryã‚’Rustã§å®Ÿè£…ã—ãŸéš›ã«ç§ãŒå­¦ã‚“ã ã“ã¨ã®å‚™å¿˜éŒ²è¨˜äº‹ã§ã™ã€‚è¨˜äº‹ã‚’æ›¸ãä¸­ã§è‡ªåˆ†ã®OpenTelemetryã®æ•´ç†ã«ã‚‚ãªã£ãŸã®ã§ã‚ˆã‹ã£ãŸã§ã™ã€‚ãŸã ã—ã€ã¾ã å®‰å®šç‰ˆãŒå‡ºã¦ã„ãªã„ã®ã‹äººæ°—ãŒãªã„ã‹ã‚‰ãªã®ã‹ã€å‚è€ƒè¨˜äº‹ã¯å°‘ãªãã€Githubä¸Šã®ã‚µãƒ³ãƒ—ãƒ«ã‚’è¦—ã„ãŸã‚Šã—ã¦è‹¦åŠ´ã—ã¾ã—ãŸã€‚ä»–ã®æ–¹ãŒãã†ãªã‚‰ãªã„ã‚ˆã†ã«ã“ã‚Œã‚’ãƒ™ãƒ¼ã‚¹ã«ã‚‚ã£ã¨æ”¹è‰¯ã—ã¦ã„ãŸã ã‘ã‚Œã°ã¨æ€ã„ã¾ã™ã€‚

èª­ã‚“ã§ãã ã•ã£ãŸæ–¹ã®å‚è€ƒã®ãŸã‚ã«è‡ªåˆ†ã®å­¦ç¿’ã§ä½œã£ãŸ[ã‚µãƒ³ãƒ—ãƒ«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³](https://github.com/kkmnky/opentelemetry-demo)ã‚’å…¬é–‹ã—ã¦ãŠãã¾ã™ã€‚æ‹™ã„ã‚³ãƒ¼ãƒ‰ã§ã¯ã‚ã‚Šã¾ã™ãŒã€å°‘ã—ã§ã‚‚å‚è€ƒã«ãªã‚Œã°å¹¸ã„ã§ã™ã€‚

æœ€å¾Œã¾ã§èª­ã‚“ã§ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚

## å‚è€ƒè¨˜äº‹

- OpenTelemetryã«ã¤ã„ã¦
  - [OpenTelemetry(å…¬å¼)](https://opentelemetry.io/)
  - [å…¥é–€ OpenTelemetry](https://www.oreilly.co.jp/books/9784814401024/)
  - [OpenTelemetryã«è§¦ã‚Œã¦ã¿ãŸ](https://zenn.dev/yuta28/articles/what-is-opentelemetry)
  - [ä»•æ§˜ã¨å®Ÿè£…ã‹ã‚‰ç†è§£ã™ã‚‹OpenTelemetryã®å…¨ä½“åƒ](https://zenn.dev/ymtdzzz/articles/37c2856f46ea10)
- OpenTelemetryâœ–ï¸Rust
  - [Rustã§OpenTelemetry](https://www.docswell.com/s/ymgyt/5Q8VL7-opentelemetry-with-rust#p1)
  - [ğŸ”­ Rustã§OpenTelemetryã‚’ã¯ã˜ã‚ã‚ˆã†](https://blog.ymgyt.io/entry/starting_opentelemetry_with_rust/)
  - [ğŸ”­ Rustã§OpenTelemetry: Tracerã®è¨­å®šã‚’ä»•æ§˜ã‹ã‚‰ç†è§£ã™ã‚‹](https://blog.ymgyt.io/entry/understanding-opentelemetry-tracer-configuration-from-specifications/)